<!DOCTYPE html>
<html lang="ja"><head>
<script src="prezemi_2024_07_presen_files/libs/clipboard/clipboard.min.js"></script>
<script src="prezemi_2024_07_presen_files/libs/quarto-html/tabby.min.js"></script>
<script src="prezemi_2024_07_presen_files/libs/quarto-html/popper.min.js"></script>
<script src="prezemi_2024_07_presen_files/libs/quarto-html/tippy.umd.min.js"></script>
<link href="prezemi_2024_07_presen_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="prezemi_2024_07_presen_files/libs/quarto-html/light-border.css" rel="stylesheet">
<link href="prezemi_2024_07_presen_files/libs/quarto-html/quarto-syntax-highlighting-722b7ecd703fa194e825a0d619ad685e.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.6.36">

  <meta name="author" content="Soichi Matsuura">
  <title>プレゼミ2024  第7章 傾向スコア法</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="prezemi_2024_07_presen_files/libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="prezemi_2024_07_presen_files/libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
      }
    pre.numberSource { margin-left: 3em;  padding-left: 4px; }
    div.sourceCode
      { color: #24292e;  }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #24292e; } /* Normal */
    code span.al { color: #ff5555; font-weight: bold; } /* Alert */
    code span.an { color: #6a737d; } /* Annotation */
    code span.at { color: #d73a49; } /* Attribute */
    code span.bn { color: #005cc5; } /* BaseN */
    code span.bu { color: #d73a49; } /* BuiltIn */
    code span.cf { color: #d73a49; } /* ControlFlow */
    code span.ch { color: #032f62; } /* Char */
    code span.cn { color: #005cc5; } /* Constant */
    code span.co { color: #6a737d; } /* Comment */
    code span.cv { color: #6a737d; } /* CommentVar */
    code span.do { color: #6a737d; } /* Documentation */
    code span.dt { color: #d73a49; } /* DataType */
    code span.dv { color: #005cc5; } /* DecVal */
    code span.er { color: #ff5555; text-decoration: underline; } /* Error */
    code span.ex { color: #d73a49; font-weight: bold; } /* Extension */
    code span.fl { color: #005cc5; } /* Float */
    code span.fu { color: #6f42c1; } /* Function */
    code span.im { color: #032f62; } /* Import */
    code span.in { color: #6a737d; } /* Information */
    code span.kw { color: #d73a49; } /* Keyword */
    code span.op { color: #24292e; } /* Operator */
    code span.ot { color: #6f42c1; } /* Other */
    code span.pp { color: #d73a49; } /* Preprocessor */
    code span.re { color: #6a737d; } /* RegionMarker */
    code span.sc { color: #005cc5; } /* SpecialChar */
    code span.ss { color: #032f62; } /* SpecialString */
    code span.st { color: #032f62; } /* String */
    code span.va { color: #e36209; } /* Variable */
    code span.vs { color: #032f62; } /* VerbatimString */
    code span.wa { color: #ff5555; } /* Warning */
  </style>
  <link rel="stylesheet" href="prezemi_2024_07_presen_files/libs/revealjs/dist/theme/quarto-25474f8ef9f6654640ac46a5aaa533dc.css">
  <link rel="stylesheet" href="mystyle.css">
  <link href="prezemi_2024_07_presen_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="prezemi_2024_07_presen_files/libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="prezemi_2024_07_presen_files/libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="prezemi_2024_07_presen_files/libs/revealjs/plugin/reveal-chalkboard/font-awesome/css/all.css" rel="stylesheet">
  <link href="prezemi_2024_07_presen_files/libs/revealjs/plugin/reveal-chalkboard/style.css" rel="stylesheet">
  <link href="prezemi_2024_07_presen_files/libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title"><p><b>プレゼミ2024</b> <br> <span style="color: #282A36; ">第7章 傾向スコア法</span></p></h1>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Soichi Matsuura 
</div>
</div>
</div>

</section>
<section>
<section id="因果推論の基本" class="title-slide slide level1 center">
<h1>因果推論の基本</h1>

</section>
<section id="因果関係の推定" class="slide level2">
<h2>因果関係の推定</h2>
<p><br></p>
<div class="v-center-container">
<p><span style="
  font-family: Myryca MM;
  font-size: 2em;
  font-weight: bold;
  color: #e3439e"> ジオングに足を付けるべきか </span></p>
</div>
<div class="v-center-container">
<p><img data-src="img/zeong.jpg"></p>
</div>
</section>
<section id="因果関係の推定-1" class="slide level2">
<h2>因果関係の推定</h2>
<p>これは、</p>
<p><br></p>
<div class="v-center-container">
<p><span style="font-size: 2em;">足 <span style="font-weight: bold; color: #e3439e">によって</span>性能が上がるかどうか</span></p>
</div>
<p><br></p>
<p>という<span class="markp">因果効果(causal effect)の因果推定(causal inference)が必要</span>となる。</p>
</section>
<section id="因果効果の推定の作法" class="slide level2">
<h2>因果効果の推定の作法</h2>
<div class="columns">
<div class="column" style="width:50%;">
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>重要</strong></p>
</div>
<div class="callout-content">
<ol type="1">
<li>Campbell アプローチ</li>
<li>Pearl アプローチ</li>
<li><strong>Rubin アプローチ</strong></li>
</ol>
</div>
</div>
</div>
<p>ルービン流の因果推定の方法を学ぶ。</p>
</div><div class="column" style="width:50%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="img/hahji_inga.jpg" class="quarto-figure quarto-figure-center" style="width:50.0%"></p>
</figure>
</div>
</div></div>
</section>
<section id="潜在的結果" class="slide level2">
<h2>潜在的結果</h2>
<p>Rubinモデルで最も重要な概念は、</p>
<div class="v-center-container">
<p><span style="font-size: 1.5em;">潜在的結果</span></p>
</div>
<ul>
<li>評価したい政策 = 処置(treatment)が対象(unit)にどのような影響を及ぼすのかを測定したい</li>
<li>因果効果の測定のために、<span class="markp">対象に処置した場合としなかった場合を比較</span></li>
<li>処置ありと処置なしの結果という2種類の<span style="font-weight">潜在的結果の差が</span><strong>因果効果</strong> <span class="math display">\[
\text{足の因果効果} = \text{足つきの性能} - \text{足なしの性能}
\]</span></li>
</ul>
</section>
<section id="反事実" class="slide level2">
<h2>反事実</h2>
<p>頭痛薬によって頭痛が治るかどうかという因果効果を推定するとしよう。 <span class="math display">\[
頭痛薬の因果効果 = 服用後の頭痛の程度 - 未服用の場合
\]</span></p>
<ul>
<li>問題は，<span class="marky">一方の潜在的結果 (薬を飲んだ場合) しか観察できない</span>こと</li>
<li><span class="markp">理想的には2人の自分を用意して1人に投薬，片方は何もせず1時間全く同じ状態に置いた後に比較したい</span></li>
<li>しかし潜在的結果の片方は観察不可能</li>
</ul>
<div class="v-center-container">
<p><span style="font-size: 2em; font-weight: bold; color: #e3439e">反事実</span></p>
</div>
</section>
<section id="潜在的結果-1" class="slide level2">
<h2>潜在的結果</h2>
<ul>
<li>潜在的成果を <span class="math inline">\(y\)</span>、処置を受けた成果を <span class="math inline">\(Y_t\)</span>、未処置を <span class="math inline">\(Y_c\)</span></li>
<li>知りたいのは、<span class="math inline">\(\mathbb{E}(Y_t - Y_c)\)</span></li>
<li>処置の有無をダミー変数<span class="math inline">\(d\)</span>、<span class="math inline">\(d=1\)</span> を処置群、<span class="math inline">\(d=0\)</span> を対象群</li>
</ul>
<table class="caption-top">
<colgroup>
<col style="width: 17%">
<col style="width: 41%">
<col style="width: 40%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th>処置群</th>
<th>対象群</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>処置有り</td>
<td><span class="math inline">\(\mathbb{E}(Y_t \mid d=1)\)</span> <sup>1</sup></td>
<td><span class="markp"><span class="math inline">\(\mathbb{E}(Y_t \mid d=0)\)</span></span></td>
</tr>
<tr class="even">
<td>処置無し</td>
<td><span class="markp"><span class="math inline">\(\mathbb{E}(Y_c \mid d=1)\)</span></span></td>
<td><span class="math inline">\(\mathbb{E}(Y_c \mid d=0)\)</span></td>
</tr>
</tbody>
</table>
<aside><ol class="aside-footnotes"><li id="fn1"><p><span class="math inline">\(d=1\)</span> を条件とした <span class="math inline">\(Y_t\)</span> の条件付期待値</p></li></ol></aside></section>
<section id="潜在的結果-2" class="slide level2">
<h2>潜在的結果</h2>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>因果効果の定義</strong></p>
</div>
<div class="callout-content">
<p><span class="math display">\[
\begin{aligned}
\text{処置群の因果効果} &amp;= \mathbb{E}(Y_t - Y_c \mid d=1) \\
    &amp;= \mathbb{E}(Y_t \mid d=1) - \mathbb{E}(Y_c \mid d=1)
\end{aligned}
\]</span></p>
</div>
</div>
</div>
<p>処置群に処置しなかった効果 <span class="math inline">\(\mathbb{E}(Y_c \mid d=1)\)</span> は反事実であるため観測不可能！ だったら<span class="markp">反事実を補完する方法を考える</span>。</p>
</section>
<section id="割当メカニズム" class="slide level2">
<h2>割当メカニズム</h2>
<p>反事実を観察できない状況下で、因果効果を推定するために重要な概念が</p>
<div class="v-center-container">
<p><span style="font-size: 2em;"><strong>割当メカニズム</strong></span> <br> <span style="fint-size: 0.5em;">allocation mechanism</span></p>
</div>
<ul>
<li>各ユニットが、処置を受けるか受けないかを決めるメカニズム</li>
<li>この割当メカニズムがどうなっているかによって、因果効果の推定方法が異なる</li>
<li><span class="markp">あるユニットへの処置が他のユニットの潜在的結果に影響を与えない</span>、という<strong>SUTVA</strong> (stable unit-treatment-value assumption)が要求される</li>
</ul>
</section>
<section id="割当メカニズム-1" class="slide level2">
<h2>割当メカニズム</h2>
<p>SUTVAが成り立つ場合、処置群と対照群の平均的な効果を、</p>
<p><br> <br></p>
<div class="v-center-container">
<p><span style="font-size: 2em"><strong>平均処置効果</strong></span></p>
</div>
</section>
<section id="rubinの完璧な医者の例" class="slide level2">
<h2>Rubinの「完璧な医者」の例</h2>
<p>ガンに対する新しい治療法の因果効果を推定したい。</p>
<ul>
<li>8名に処置した場合と処置しない場合の生存年数を比べる(<em>不可能</em>)。</li>
<li>平均因果効果を比べると，処置しない方が長生きできるため，処置すべきでない。</li>
<li>しかし神の視点により，<span class="marky">処置すると生存年数が延びる患者にのみ処置すると，生存年数が延びる</span>。</li>
</ul>
<p>このように割当メカニズムにより，処置の効果が全く逆になることもある。 このような問題は，<strong>混合的なメカニズム</strong>(confounded mechanism)によって生じている。</p>
</section>
<section id="割当メカニズム-2" class="slide level2">
<h2>割当メカニズム</h2>
<div class="v-center-container">
<p><span style="font-size: 2em"><strong>混合的なメカニズム</strong></span></p>
</div>
<ul>
<li>処置を受けるか受けないかの決定が，潜在的結果を考慮に入れて行われているもの。</li>
<li>潜在的結果を先取りしており，<strong>内生性</strong>(endogenous)の問題が生じる。</li>
<li>しかし混合的<strong>でない</strong>割当メカニズムのケースでは，因果効果を推定することは比較的容易となる。</li>
</ul>
</section>
<section id="ランダム化比較対照実験" class="slide level2">
<h2>ランダム化比較対照実験</h2>
<p>混合的<strong>でない</strong>割当メカニズムとして一般的なのがランダム化比較対象実験(RCT: randomized controlled trial)</p>
<ul>
<li>被験者を，処置群と対象群に割り当て，</li>
<li>処置群と対象群の差(つまり平均因果効果)を見て，</li>
<li>処置の因果効果を推定する方法</li>
</ul>
<p>このメカニズムは潜在的結果を考慮に入れていないため，混合的ではない。</p>
<ul>
<li>ランダム化比較対照実験では，試行ごとに異なる結果が出る。</li>
<li><span class="markp">何度も試行を繰り返す <span class="math inline">\(n\rightarrow \infty\)</span> で，真の平均因果効果を推定できる</span>。</li>
</ul>
</section>
<section id="ランダム化比較対照実験-1" class="slide level2">
<h2>ランダム化比較対照実験</h2>
<p>潜在的結果を考慮にいれず割当を行う。つまり<span class="markp"><span class="math inline">\(Y_c\)</span>と<span class="math inline">\(d\)</span>が独立であるという仮定が成り立つなら</span>，</p>
<p><span class="math display">\[
\begin{aligned}
\mbox{処置群の因果効果} \approx \mathbb{E}(Y_t \mid d=1) - \mathbb{E}(Y_c \mid d=0)
\end{aligned}
\]</span> と近似できる。さらにここから， <span class="math display">\[
\begin{aligned}
ACE = \Pr (d=1) \mathbb{E} (Y_t - Y_c \mid d=1 ) - \Pr (d=0) \mathbb{E} (Y_t - Y_c \mid d=0 )
\end{aligned}
\]</span> を計算する。 しかし <span class="marky"><span class="math inline">\(\mathbb{E}(Y_c \mid d=1)\)</span> と <span class="math inline">\(\mathbb{E}(Y_t \mid d=0)\)</span> が観察不可能</span>である。</p>
</section>
<section class="slide level2">

<p>しかし <span class="math inline">\(Y_t\)</span> が <span class="math inline">\(d\)</span> と独立なら， <span class="math display">\[
\begin{aligned}
ACE = ATE \approx \mathbb{E}(Y_t \mid d=1 ) - \mathbb{E}(Y_c \mid d=0)
\end{aligned}
\]</span></p>
<p>となる。これが成立するためには，割当を完全にランダムに行えばよい。 ただし，<span class="markp">社会科学において，政策評価をランダム化比較対照実験を用いて実行することは困難</span>である。</p>
<ul>
<li>通常被験者が割当を自発的に選択するため、<span class="markp">被験者が割当を選んだ結果である観察データ(observational data)を用いて</span>， 処置群と対象群を比較しただけでは，平均因果効果を推定することは困難</li>
<li>これを実行しようとしているが<span class="marky">フィールド実験(field experiment)</span></li>
</ul>
</section>
<section id="階層化" class="slide level2">
<h2>階層化</h2>
<p>ランダム割当でない観察データの場合に平均因果効果を推定するために，ランダム化比較対照実験におけるランダム化の意味を考える。</p>
<ul>
<li>処置以外で潜在的結果に影響を与える要因</li>
</ul>
<div class="v-center-container">
<p><span style="font-size: 2em"><strong>共変量</strong></span></p>
</div>
<ul>
<li><span class="markp">共変量は処置前後で値が変わらないという特徴</span>をもつ。</li>
<li>個人の因果効果の観察は処置以外の共変量の影響を受ける。</li>
<li>しかし，ランダム割当により(十分大きな <span class="math inline">\(N\)</span> において)<strong>平均的には</strong>真の因果効果を推定するため，処置群と対象群をランダムに振り分けることで共変量を相殺する。</li>
</ul>
</section>
<section id="階層化下位分類化" class="slide level2">
<h2>階層化・下位分類化</h2>
<ol type="1">
<li>重要な共変量をピックアップ</li>
<li>処置群と対象群とから，<span class="markp">共変量がバランスしているサブグループを選択</span></li>
<li>2つのサブ・グループについての観察結果の差を見て，共変量の影響を除去</li>
<li>各サブグループの平均因果効果を推定する。</li>
</ol>
<p>この手順を<strong>階層化</strong>(stratification)とか<strong>下位分類化</strong>(subclassification)という。</p>
</section>
<section id="心得" class="slide level2">
<h2>心得</h2>
<ul>
<li><p><strong>ランダム化比較対照実験</strong>(randomized controlled trial: RCT)では，分析者がランダム化という割当メカニズムを採用しているため，因果効果の推定に恣意性が小さい。</p></li>
<li><p>ただ，観察データに階層化を用いてRCTに近似した状況を作り出そうとする場合，</p>
<ol type="1">
<li>どの共変量に着目し，</li>
<li>どのくらいの大きさのサブグループを作るか，</li>
</ol></li>
</ul>
<p>という点で恣意性が入る。</p>
</section>
<section id="心得2" class="slide level2">
<h2>心得2</h2>
<p><strong>建前として</strong>以下のステップを踏む。</p>
<ul>
<li>設計段階では結果を見ない。</li>
<li><span class="markp">結果を見る前に</span>，割当メカニズムで重要な共変量を考える。</li>
<li>共変量のバランスが達成できるサブグループを作る。</li>
<li>思い通りの結果がでなくても諦める。</li>
</ul>
</section>
<section id="まとめ" class="slide level2">
<h2>まとめ</h2>
<ul>
<li>因果効果を推定するためには、同じユニットに対して処置した場合と未処置の場合を比較する必要があるが、それは無理な場合がある</li>
<li><span class="markp">処置群に処置を施さなかったらどうなっていたか、という反事実を補完する</span>ことで、因果効果の推定を行う</li>
<li>このときユニットが<span class="markp">処置群・対象群のどちらに入るのかを決める割当メカニズム</span>が<strong>重要</strong></li>
<li><span class="markb">潜在的結果を考慮しない割当メカニズムではランダム化比較対象実験が可能</span></li>
<li>ユニットが処置を受けるかどうかを自分で選ぶような<span class="marky">潜在的結果を考慮した割当メカニズムでは、共変量に基づく階層化・下位分類化を行い比較する</span></li>
</ul>
</section></section>
<section>
<section id="マッチング" class="title-slide slide level1 center">
<h1>マッチング</h1>

</section>
<section id="マッチング-1" class="slide level2">
<h2>マッチング</h2>
<ul>
<li><span class="markp">反事実の補完のため</span>に用いられるのがマッチングである。</li>
<li>階層化は，共変量がバランスしているサブグループを選び，片方に処置を行った上で比較し，因果効果を推定する方法だった。</li>
<li>つまりグループとグループを平均的に比較する方法である。</li>
</ul>
<p>マッチングはこのアイデアの延長線上にある。</p>
</section>
<section id="マッチング-2" class="slide level2">
<h2>マッチング</h2>
<ul>
<li>グループでは無く，ユニット(unit)ごとに共変量が同じものを対象群から抽出し，反事実とする方法。</li>
<li>このように<span class="markp">対応づけられた処置群のユニットと対象群のユニットを比較して</span>処置の因果効果を推定する。</li>
</ul>
<div class="v-center-container">
<p><span style="font-size: 2em; font-weight: bold; color: #e3439e">マッチング</span></p>
</div>
</section>
<section id="具体例" class="slide level2">
<h2>具体例</h2>
<div style="font-size: .5em;">
<table class="caption-top" style="width:100%;">
<colgroup>
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 8%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 8%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 8%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"></th>
<th style="text-align: center;">処置群</th>
<th style="text-align: right;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;">対照群</th>
<th style="text-align: right;"></th>
<th style="text-align: center;"></th>
<th style="text-align: center;">マッチング</th>
<th style="text-align: right;"></th>
<th style="text-align: right;"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">id</td>
<td style="text-align: center;">年</td>
<td style="text-align: right;">年収</td>
<td style="text-align: center;">id</td>
<td style="text-align: center;">年</td>
<td style="text-align: right;">年収</td>
<td style="text-align: center;">id</td>
<td style="text-align: center;">年</td>
<td style="text-align: right;">年収</td>
<td style="text-align: right;">差</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: center;">28</td>
<td style="text-align: right;">35,400</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">28</td>
<td style="text-align: right;">35,400</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">28</td>
<td style="text-align: right;">17,600</td>
<td style="text-align: right;">17,800</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: center;">34</td>
<td style="text-align: right;">20,400</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">28</td>
<td style="text-align: right;">35,400</td>
<td style="text-align: center;">14</td>
<td style="text-align: center;">34</td>
<td style="text-align: right;">48,400</td>
<td style="text-align: right;">-28,000</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: center;">29</td>
<td style="text-align: right;">28,800</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">30</td>
<td style="text-align: right;">42,000</td>
<td style="text-align: center;">17</td>
<td style="text-align: center;">29</td>
<td style="text-align: right;">12,400</td>
<td style="text-align: right;">16,400</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: center;">25</td>
<td style="text-align: right;">41,600</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">27</td>
<td style="text-align: right;">18,600</td>
<td style="text-align: center;">15</td>
<td style="text-align: center;">25</td>
<td style="text-align: right;">46,600</td>
<td style="text-align: right;">-5,000</td>
</tr>
<tr class="even">
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
<td style="text-align: right;">…</td>
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
<td style="text-align: right;">…</td>
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
<td style="text-align: right;">…</td>
<td style="text-align: right;">…</td>
</tr>
<tr class="odd">
<td style="text-align: center;">18</td>
<td style="text-align: center;">27</td>
<td style="text-align: right;">21,400</td>
<td style="text-align: center;">18</td>
<td style="text-align: center;">28</td>
<td style="text-align: right;">35,400</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">27</td>
<td style="text-align: right;">18,600</td>
<td style="text-align: right;">2,800</td>
</tr>
<tr class="even">
<td style="text-align: center;">19</td>
<td style="text-align: center;">28</td>
<td style="text-align: right;">32,600</td>
<td style="text-align: center;">19</td>
<td style="text-align: center;">28</td>
<td style="text-align: right;">35,400</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">28</td>
<td style="text-align: right;">17,600</td>
<td style="text-align: right;">15,000</td>
</tr>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: right;"></td>
<td style="text-align: center;">20</td>
<td style="text-align: center;">23</td>
<td style="text-align: right;">19,000</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: right;"></td>
<td style="text-align: center;">21</td>
<td style="text-align: center;">32</td>
<td style="text-align: right;">51,800</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">平均</td>
<td style="text-align: center;"><span class="markp">28.5</span></td>
<td style="text-align: right;"><span class="marky">32,854</span></td>
<td style="text-align: center;">平均</td>
<td style="text-align: center;"><span class="markp">33</span></td>
<td style="text-align: right;"><span class="marky">41,448</span></td>
<td style="text-align: center;">平均</td>
<td style="text-align: center;">28.5</td>
<td style="text-align: right;">27,963</td>
<td style="text-align: right;"><em>4,889</em></td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>各群の平均を比較すると処置群の方が低い！</li>
<li>しかし平均年齢は処置群の方が低い！</li>
<li>マッチングしてコントロールしたい。</li>
</ul>
</section>
<section id="マッチング-3" class="slide level2">
<h2>マッチング</h2>
<ul>
<li>マッチングにより，<span class="markp">処置群における平均因果効果(ACET)のみならず，対象群における平均因果効果(ACEC)も計算できる</span>。</li>
<li>処置群と対象群全体を通じた全体における平均因果効果(average causal effect: ACE)も計算できる。</li>
</ul>
<p>職業訓練の例では，</p>
<ul>
<li>処置群における平均因果効果は<span class="math inline">\(4,889\)</span>となり，職業訓練により年収が増加</li>
<li>対象群における平均因果効果は，対象群21ユニットに処置群19ユニットを対応づけることで計算</li>
<li>全体の平均因果効果は処置群と対象群の平均因果効果から計算</li>
</ul>
</section>
<section id="複数の共変量" class="slide level2">
<h2>複数の共変量</h2>
<ul>
<li>マッチングには複数の共変量を用いたほうがよいが、複数の共変量を用いたマッチングでは，<span class="markp">近さを定義し，組み合わせを選ぶ必要がある</span>。</li>
<li><strong>距離基準</strong>として，<span class="marky">正規ユークリッド距離とマハラノビス距離</span>が便利</li>
<li>ユークリッド距離 <span class="math inline">\(d(y,x) = \sqrt{\sum (y_i - x_i)^2}\)</span> ではなく，</li>
</ul>
<p><span class="math display">\[
d_M (\boldsymbol{y,x}) = \sqrt{(\boldsymbol{x} - \boldsymbol{y})^{\top} \boldsymbol{\Sigma }^{-1} (\boldsymbol{x}-\boldsymbol{y})}
\]</span> を用いる。 <span class="math inline">\(\boldsymbol{\Sigma}\)</span>は<span class="math inline">\(\boldsymbol{x}\)</span>の共分散行列である。</p>
</section>
<section id="複数の共変量-1" class="slide level2">
<h2>複数の共変量</h2>
<p><span class="math inline">\(\boldsymbol{\Sigma}\)</span> が対角行列の場合，正規ユークリッド距離という。</p>
<p><span class="math display">\[
d_M(\boldsymbol{y,x}) = \sqrt{\sum(x_i - y_i)^2/\sigma_i ^2}
\]</span></p>
<p><span class="math inline">\(\boldsymbol{\Sigma}\)</span> が単位行列なら，マハラノビス距離はユークリッド距離に等しくなる。</p>
<p><span class="math display">\[
d_M (\boldsymbol{y,x}) = \sqrt{(\boldsymbol{x} - \boldsymbol{y})^{\top}
\begin{pmatrix}
\sigma_{11} &amp;  &amp; \text{\large{0}} \\
&amp; \ddots &amp;  \\
\text{\large{0}} &amp;  &amp; \sigma_{nn} \\
\end{pmatrix} ^{-1}
(\boldsymbol{x}-\boldsymbol{y})}
\]</span></p>
</section>
<section id="複数の共変量-2" class="slide level2">
<h2>複数の共変量</h2>
<ul>
<li>一部の共変量とは完全一致で，他の共変量とは距離が最小になるマッチングを<strong>正確マッチング</strong>(exact matching)という。</li>
<li>Rで正確マッチングをするためには，<code>Matchit</code>パッケージの<code>matchit()</code>関数を用いる。</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href=""></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidyverse, AER, estimatr, MatchIt)</span>
<span id="cb1-2"><a href=""></a><span class="fu">data</span>(<span class="st">"PSID1982"</span>)</span>
<span id="cb1-3"><a href=""></a></span>
<span id="cb1-4"><a href=""></a><span class="fu">lm_robust</span>(<span class="fu">log</span>(wage) <span class="sc">~</span> occupation <span class="sc">+</span> education <span class="sc">+</span> south <span class="sc">+</span> smsa <span class="sc">+</span> gender <span class="sc">+</span> ethnicity <span class="sc">+</span> industry <span class="sc">+</span> weeks, <span class="at">data =</span> PSID1982)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    Estimate  Std. Error      t value      Pr(&gt;|t|)
(Intercept)     6.3023136910 0.175077599  35.99725906 1.387672e-150
occupationblue -0.1395675030 0.037132508  -3.75863385  1.879532e-04
education       0.0510611291 0.007213451   7.07859910  4.179497e-12
southyes       -0.0849846890 0.034214451  -2.48388287  1.327422e-02
smsayes         0.1793275171 0.030659738   5.84895787  8.226856e-09
genderfemale   -0.4463245183 0.038664691 -11.54346517  6.436339e-28
ethnicityafam  -0.1921038599 0.058100604  -3.30640037  1.002829e-03
industryyes     0.1073240453 0.030046094   3.57197991  3.834060e-04
weeks          -0.0001191249 0.002944063  -0.04046274  9.677380e-01
                   CI Lower     CI Upper  DF
(Intercept)     5.958457704  6.646169678 586
occupationblue -0.212496509 -0.066638497 586
education       0.036893763  0.065228495 586
southyes       -0.152182571 -0.017786807 586
smsayes         0.119111164  0.239543870 586
genderfemale   -0.522262763 -0.370386273 586
ethnicityafam  -0.306214636 -0.077993084 586
industryyes     0.048312901  0.166335189 586
weeks          -0.005901325  0.005663075 586</code></pre>
</div>
</div>
</section>
<section id="正確マッチング" class="slide level2">
<h2>正確マッチング</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href=""></a>fit.m <span class="ot">&lt;-</span> <span class="fu">matchit</span>(occupation <span class="sc">~</span> education <span class="sc">+</span> south <span class="sc">+</span> smsa <span class="sc">+</span> gender <span class="sc">+</span> ethnicity <span class="sc">+</span> industry <span class="sc">+</span> weeks,</span>
<span id="cb3-2"><a href=""></a>                 <span class="at">data =</span> PSID1982,</span>
<span id="cb3-3"><a href=""></a>                 <span class="at">method =</span> <span class="st">"exact"</span>,</span>
<span id="cb3-4"><a href=""></a>                 <span class="at">estimand =</span> <span class="st">"ATC"</span></span>
<span id="cb3-5"><a href=""></a>                 )</span>
<span id="cb3-6"><a href=""></a>fit.m</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A `matchit` object
 - method: Exact matching
 - number of obs.: 595 (original), 164 (matched)
 - target estimand: ATC
 - covariates: education, south, smsa, gender, ethnicity, industry, weeks</code></pre>
</div>
</div>
</section>
<section id="次元の呪い" class="slide level2">
<h2>次元の呪い</h2>
<ul>
<li>複数の共変量を用いると，完全な一致が得られにくくなる。</li>
<li>サンプルサイズが小さい場合はなおさら反事実の補完とは言いがたい。</li>
<li>共変量の数が多すぎると，よいマッチングが出来なくなる。</li>
</ul>
<div class="v-center-container">
<p><span style="font-size: 2em; font-weight: bold; color: #e3439e">次元の呪い</span></p>
</div>
<ul>
<li>回避方法は、対象群のサンプル・サイズを大きくし，よいマッチング対象が見つかる可能性を高める。</li>
<li>サンプル・サイズを大きく出来ない場合は，バイアス修正方法を用いる。</li>
</ul>
</section>
<section id="傾向スコアマッチング" class="slide level2">
<h2>傾向スコア・マッチング</h2>
<ul>
<li>マッチングに用いる共変量が複数存在し，マッチングによる反事実の補完が機能しない<strong>次元の呪い</strong>を克服するために，近年良く用いられている(ような気がする)方法が<strong>傾向スコア・マッチング</strong>(propensity score matching)
<ul>
<li><span class="markp">傾向スコアとは処置を受ける確率のこと</span>。</li>
<li>この傾向スコアを使ってマッチングをすることで反事実を補完</li>
</ul></li>
</ul>
<p>ただし次の判別条件を満たしている必要がある。</p>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>判別条件</strong></p>
</div>
<div class="callout-content">
<ol type="1">
<li>処置を受けるかどうかが観察可能な共変量に基づいている。</li>
<li>傾向スコアが0超，1未満の間をとること。</li>
</ol>
</div>
</div>
</div>
</section>
<section id="例テレビcmの効果測定" class="slide level2">
<h2>例：テレビCMの効果測定</h2>
<p>CM見たグループ vs.&nbsp;見てないグループの購買量比較</p>
<div style="font-size: .8em;">
<table class="caption-top">
<thead>
<tr class="header">
<th></th>
<th style="text-align: center;">処置群</th>
<th style="text-align: center;">対象群</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>CM見た</td>
<td style="text-align: center;">購買量</td>
<td style="text-align: center;"><strong>反事実</strong></td>
</tr>
<tr class="even">
<td>CM見てない</td>
<td style="text-align: center;"><strong>反事実</strong></td>
<td style="text-align: center;">購買量</td>
</tr>
<tr class="odd">
<td>共変量</td>
<td style="text-align: center;">収入，年齢など</td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>処置群と対照群は観測値であるため、コントロール不可なので共変量の項目から<strong>処置群</strong>である確率を算出</li>
<li>通常はロジット・モデルやプロビット・モデル、順序ロジットといった従属変数の値が0から1に収まる回帰モデルを用いて推定</li>
</ul>
</section></section>
<section>
<section id="傾向スコア法" class="title-slide slide level1 center">
<h1>傾向スコア法</h1>

</section>
<section id="傾向スコアとは" class="slide level2">
<h2>傾向スコアとは？</h2>
<p>傾向スコア法とは，<span class="markp">プログラム参加者(処置群)と非参加者(対照群)の中で参加者とよく似た人を探し出して比較する手法</span>。 「よく似た人」をどのように探すのか？が問題</p>
<ul>
<li>プロビット・モデルやロジット・モデルを使って，<span class="markp">プログラム参加者である確率を推定</span>する。</li>
<li>説明変数として，プログラム参加者であるかどうかを除いた共変量を使う。</li>
<li>このように計算された「プログラム参加者となる確率」を使って，非参加者の中で参加者と同じ程度の参加確率を持つ人を探し出し，対照群とする。</li>
</ul>
</section>
<section id="傾向スコアマッチングの手順" class="slide level2">
<h2>傾向スコア・マッチングの手順</h2>
<ol type="1">
<li>プロビット/ロジット・モデルで対照群となる確率(傾向スコア)を推定</li>
<li>処置群の個体<span class="math inline">\(i\)</span>と同じような傾向スコアをもつ対照群の個体を探し出して1対1でマッチング</li>
<li>処置群と対照群の平均的な効果(ATT)を比較</li>
</ol>
</section>
<section id="処置効果の種類" class="slide level2">
<h2>処置効果の種類</h2>
<ul>
<li>処置群と対照群の成果指標の平均の差: <strong>ATT</strong> (Average Treatment Effect on Treated)</li>
<li>比較群における平均処置効果: <strong>ATUT</strong> (Average Treatment Effect on Un-Treated)</li>
<li>全ての人が処置を受けた場合の平均処置効果: <strong>ATE</strong> (Average Treatment Effect)</li>
</ul>
</section>
<section id="データの準備" class="slide level2">
<h2>データの準備</h2>
<ul>
<li>使うデータは<code>nswcps_pamatch.csv</code></li>
<li>パッケージは<code>MatchIt</code></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href=""></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidyverse, MatchIt)</span>
<span id="cb5-2"><a href=""></a>nswcps <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">"data/nswcps_psmatch.csv"</span>)</span>
<span id="cb5-3"><a href=""></a><span class="fu">glimpse</span>(nswcps)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 16,177
Columns: 22
$ treated    &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ age        &lt;dbl&gt; 37, 22, 30, 27, 33, 22, 23, 32, 22, 33, 19, 21, 18, 27, 17,…
$ educ       &lt;dbl&gt; 11, 9, 12, 11, 8, 9, 12, 11, 16, 12, 9, 13, 8, 10, 7, 10, 1…
$ black      &lt;dbl&gt; 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ hispanic   &lt;dbl&gt; 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ married    &lt;dbl&gt; 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0,…
$ nodegree   &lt;dbl&gt; 1, 1, 0, 1, 1, 1, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 0, 0,…
$ re74       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ re75       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ re78       &lt;dbl&gt; 9930.0460, 3595.8940, 24909.4500, 7506.1460, 289.7899, 4056…
$ data_id    &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ education  &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
$ age2       &lt;dbl&gt; 1369, 484, 900, 729, 1089, 484, 529, 1024, 484, 1089, 361, …
$ age3       &lt;dbl&gt; 50653, 10648, 27000, 19683, 35937, 10648, 12167, 32768, 106…
$ un74       &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ un75       &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ educ2      &lt;dbl&gt; 121, 81, 144, 121, 64, 81, 144, 121, 256, 144, 81, 169, 64,…
$ educ_black &lt;dbl&gt; 11, 0, 12, 11, 8, 9, 12, 11, 16, 0, 9, 13, 8, 10, 7, 10, 13…
$ educ_re74  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ re74_2     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ re75_2     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ black_un74 &lt;dbl&gt; 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…</code></pre>
</div>
</div>
<p>16177観測値と23変数からなるデータセット</p>
</section>
<section id="傾向スコアの推定" class="slide level2">
<h2>傾向スコアの推定</h2>
<p>Dehajia and Wahba (1999)のデータを使った傾向スコア・マッチングの実践</p>
<ul>
<li>成果指標<code>re78</code> : 1978年の年収</li>
<li>処置群<code>treated</code> : トリートメント群かどうか（参加なら1, 非参加なら0）</li>
<li>共変量
<ul>
<li><code>re74</code>, <code>re75</code> : 1974年，1975年の年収</li>
<li><code>age</code>, <code>age2</code> : 年齢とその2乗</li>
<li><code>educ</code> : 教育年数</li>
<li><code>nodegree</code> : 高校中退なら1，それ以外は0</li>
<li><code>black</code> : 黒人ダミー</li>
<li><code>hispanic</code> : ヒスパニックダミー</li>
</ul></li>
</ul>
</section>
<section id="データの概要" class="slide level2">
<h2>データの概要</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href=""></a>nswcps <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href=""></a>  tableone<span class="sc">::</span><span class="fu">CreateTableOne</span>(</span>
<span id="cb7-3"><a href=""></a>  <span class="at">vars =</span> (<span class="fu">c</span>(<span class="st">"re78"</span>,<span class="st">"age"</span>,<span class="st">"educ"</span>,<span class="st">"married"</span>,<span class="st">"black"</span>,<span class="st">"hispanic"</span>)), <span class="at">strata =</span> <span class="st">"treated"</span></span>
<span id="cb7-4"><a href=""></a>  )</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                      Stratified by treated
                       0                  1                 p      test
  n                       15992               185                      
  re78 (mean (SD))     14846.66 (9647.39) 6349.14 (7867.40) &lt;0.001     
  age (mean (SD))         33.23 (11.05)     25.82 (7.16)    &lt;0.001     
  educ (mean (SD))        12.03 (2.87)      10.35 (2.01)    &lt;0.001     
  married (mean (SD))      0.71 (0.45)       0.19 (0.39)    &lt;0.001     
  black (mean (SD))        0.07 (0.26)       0.84 (0.36)    &lt;0.001     
  hispanic (mean (SD))     0.07 (0.26)       0.06 (0.24)     0.510     </code></pre>
</div>
</div>
<p>処置群が185，対照群が15992</p>
</section>
<section id="プログラム参加確率の推定" class="slide level2">
<h2>プログラム参加確率の推定</h2>
<p>ロジットモデルによるプログラム参加確率の推定</p>
<p><span class="math display">\[
\begin{aligned}
\text{treated} &amp;= \beta_0 + \beta_1 \text{age} + \beta_2 \text{age2} + \beta_3 \text{educ} + \beta_4 \text{educ2} \\
                &amp; + \beta_5 \text{married} + \beta_6 \text{nodegree} + \beta_7 \text{black}\\
                &amp;+ \beta_8 \text{hispanic} + \beta_9 \text{re74} + \beta_{10} \text{re75}
\end{aligned}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href=""></a>logit_model <span class="ot">&lt;-</span> <span class="st">"treated ~ age + age2 + educ + educ2 + married + nodegree + black + hispanic + re74 + re75"</span></span>
<span id="cb9-2"><a href=""></a>result_logit1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(logit_model, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>), <span class="at">data =</span> nswcps)</span>
<span id="cb9-3"><a href=""></a>DescTools<span class="sc">::</span><span class="fu">PseudoR2</span>(result_logit1)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<!--
## 傾向スコア

`treated`をグループとして，傾向スコアの箱ひげ図を描く



::: {.cell}

```{.r .cell-code}
nswcps$ps <- result_logit1$fitted.values
nswcps %>%
  ggplot(aes(x = ps, fill = factor(treated), group = factor(treated))) +
  geom_boxplot() +
  theme_minimal()
```

::: {.cell-output-display}
![](prezemi_2024_07_presen_files/figure-revealjs/unnamed-chunk-7-1.png){width=960}
:::
:::


-->
</section>
<section id="プログラム参加確率の推定-output" class="slide level2 output-location-slide"><h2>プログラム参加確率の推定</h2><div class="cell output-location-slide">
<div class="cell-output cell-output-stdout">
<pre><code> McFadden 
0.5646388 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href=""></a><span class="fu">summary</span>(result_logit1)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = logit_model, family = binomial(link = "logit"), 
    data = nswcps)

Coefficients:
              Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) -1.924e+01  1.824e+00 -10.553  &lt; 2e-16 ***
age          7.962e-01  9.086e-02   8.763  &lt; 2e-16 ***
age2        -1.274e-02  1.536e-03  -8.295  &lt; 2e-16 ***
educ         8.831e-01  2.359e-01   3.743 0.000182 ***
educ2       -5.009e-02  1.253e-02  -3.997 6.42e-05 ***
married     -1.505e+00  2.431e-01  -6.189 6.05e-10 ***
nodegree     8.830e-01  3.092e-01   2.856 0.004290 ** 
black        3.857e+00  2.603e-01  14.820  &lt; 2e-16 ***
hispanic     1.651e+00  3.982e-01   4.145 3.40e-05 ***
re74        -7.033e-05  2.872e-05  -2.449 0.014344 *  
re75        -2.229e-04  3.715e-05  -5.999 1.98e-09 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 2022.14  on 16176  degrees of freedom
Residual deviance:  880.36  on 16166  degrees of freedom
AIC: 902.36

Number of Fisher Scoring iterations: 10</code></pre>
</div>
</div></section><section id="マッチング-4" class="slide level2">
<h2>マッチング</h2>
<p><code>MatchIt</code>パッケージの<code>matchit()</code>関数を使ってマッチングする。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href=""></a>m_result1 <span class="ot">&lt;-</span> MatchIt<span class="sc">::</span><span class="fu">matchit</span>(treated <span class="sc">~</span> age<span class="sc">+</span>age2<span class="sc">+</span>educ<span class="sc">+</span>educ2<span class="sc">+</span>married<span class="sc">+</span>nodegree<span class="sc">+</span>black<span class="sc">+</span>hispanic<span class="sc">+</span>re74<span class="sc">+</span>re75,</span>
<span id="cb13-2"><a href=""></a>                 <span class="at">data     =</span> nswcps,</span>
<span id="cb13-3"><a href=""></a>                 <span class="at">method   =</span> <span class="st">"nearest"</span>,</span>
<span id="cb13-4"><a href=""></a>                 <span class="at">distance =</span> <span class="st">"glm"</span>, <span class="at">discard =</span> <span class="st">"both"</span>,</span>
<span id="cb13-5"><a href=""></a>                 <span class="at">replace  =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-6"><a href=""></a><span class="fu">summary</span>(m_result1)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<ul>
<li><code>method = "nearest"</code> : 最近傍マッチング</li>
<li><code>distance = "glm"</code> : ロジット・モデルを使って傾向スコアを推定</li>
<li><code>discard = "both"</code> : 処置群と対照群のどちらかにマッチングしないデータを削除</li>
<li><code>replace = TRUE</code> : 重複を許す</li>
</ul>
</section>
<section id="マッチング-4-output" class="slide level2 output-location-slide"><h2>マッチング</h2><div class="cell output-location-slide">
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
MatchIt::matchit(formula = treated ~ age + age2 + educ + educ2 + 
    married + nodegree + black + hispanic + re74 + re75, data = nswcps, 
    method = "nearest", distance = "glm", discard = "both", replace = TRUE)

Summary of Balance for All Data:
         Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
distance        0.3610        0.0074          1.3727    36.2999    0.5090
age            25.8162       33.2252         -1.0355     0.4196    0.1863
age2          717.3946     1225.9056         -1.1792     0.3020    0.1863
educ           10.3459       12.0275         -0.8363     0.4905    0.0908
educ2         111.0595      152.9023         -1.0646     0.3424    0.0908
married         0.1892        0.7117         -1.3342          .    0.5225
nodegree        0.7081        0.2958          0.9068          .    0.4123
black           0.8432        0.0735          2.1171          .    0.7697
hispanic        0.0595        0.0720         -0.0532          .    0.0126
re74         2095.5737    14016.8003         -2.4396     0.2607    0.4591
re75         1532.0553    13650.8034         -3.7645     0.1206    0.4751
         eCDF Max
distance   0.8655
age        0.3427
age2       0.3427
educ       0.4123
educ2      0.4123
married    0.5225
nodegree   0.4123
black      0.7697
hispanic   0.0126
re74       0.6031
re75       0.6509

Summary of Balance for Matched Data:
         Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
distance        0.3556        0.3558         -0.0008     0.9912    0.0001
age            25.7596       26.1749         -0.0580     0.9422    0.0298
age2          714.6885      739.0164         -0.0564     1.0475    0.0298
educ           10.3716       10.4208         -0.0245     0.9227    0.0112
educ2         111.5738      112.9016         -0.0338     0.8002    0.0112
married         0.1913        0.2022         -0.0279          .    0.0109
nodegree        0.7049        0.7158         -0.0240          .    0.0109
black           0.8415        0.8634         -0.0601          .    0.0219
hispanic        0.0601        0.0328          0.1155          .    0.0273
re74         2118.4761     2185.9851         -0.0138     1.6503    0.0290
re75         1548.7991     1658.9149         -0.0342     1.0428    0.0113
         eCDF Max Std. Pair Dist.
distance   0.0273          0.0076
age        0.1202          0.9119
age2       0.1202          0.8646
educ       0.0437          0.9213
educ2      0.0437          0.9606
married    0.0109          0.6139
nodegree   0.0109          0.6731
black      0.0219          0.3006
hispanic   0.0273          0.3004
re74       0.1913          0.6246
re75       0.0601          0.6303

Sample Sizes:
               Control Treated
All           15992.       185
Matched (ESS)    81.09     183
Matched         119.       183
Unmatched      4834.         0
Discarded     11039.         2</code></pre>
</div>
</div></section><section id="マッチングの結果" class="slide level2">
<h2>マッチングの結果</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href=""></a><span class="fu">summary</span>(m_result1) <span class="sc">%&gt;%</span> <span class="fu">plot</span>(<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">1.5</span>))</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>

</div>
<img data-src="prezemi_2024_07_presen_files/figure-revealjs/unnamed-chunk-9-1.png" width="960" class="r-stretch"><p><code>hispanic</code>以外はうまくマッチングできている</p>
</section>
<section id="処置効果の計算" class="slide level2">
<h2>処置効果の計算</h2>
<p>処置群と対照群だけのデータセット<code>matched_data</code>を作成</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href=""></a>matched_data <span class="ot">&lt;-</span> m_result1 <span class="sc">%&gt;%</span> MatchIt<span class="sc">::</span><span class="fu">match.data</span>()</span>
<span id="cb16-2"><a href=""></a><span class="fu">head</span>(matched_data)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 25
  treated   age  educ black hispanic married nodegree  re74  re75   re78 data_id
    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  
1       1    37    11     1        0       1        1     0     0  9930. &lt;NA&gt;   
2       1    22     9     0        1       0        1     0     0  3596. &lt;NA&gt;   
3       1    30    12     1        0       0        0     0     0 24909. &lt;NA&gt;   
4       1    27    11     1        0       0        1     0     0  7506. &lt;NA&gt;   
5       1    22     9     1        0       0        1     0     0  4056. &lt;NA&gt;   
6       1    23    12     1        0       0        0     0     0     0  &lt;NA&gt;   
# ℹ 14 more variables: education &lt;dbl&gt;, age2 &lt;dbl&gt;, age3 &lt;dbl&gt;, un74 &lt;dbl&gt;,
#   un75 &lt;dbl&gt;, educ2 &lt;dbl&gt;, educ_black &lt;dbl&gt;, educ_re74 &lt;dbl&gt;, re74_2 &lt;dbl&gt;,
#   re75_2 &lt;dbl&gt;, black_un74 &lt;dbl&gt;, ps &lt;dbl&gt;, distance &lt;dbl&gt;, weights &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
<section id="処置効果の推計" class="slide level2">
<h2>処置効果の推計</h2>
<p><code>lm()</code>関数を使って年収<code>re78</code>を処置群と対照群で比較する。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href=""></a>m_result2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treated, <span class="at">data =</span> matched_data, <span class="at">weights =</span> weights)</span>
<span id="cb18-2"><a href=""></a><span class="fu">summary</span>(m_result2)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = re78 ~ treated, data = matched_data, weights = weights)

Weighted Residuals:
   Min     1Q Median     3Q    Max 
 -8158  -5142  -2242   3519  53901 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   4524.5      663.3   6.821 4.99e-11 ***
treated       1881.9      852.1   2.209    0.028 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 7236 on 300 degrees of freedom
Multiple R-squared:  0.016, Adjusted R-squared:  0.01272 
F-statistic: 4.878 on 1 and 300 DF,  p-value: 0.02796</code></pre>
</div>
</div>
<p><code>treated</code>の係数が統計的に正に有意であるため，処置群の年収は対照群よりも1881.9ドル高いと言える。</p>

</section></section>

    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<p><img src="img/yoko.jpg" class="slide-logo"></p>
<div class="footer footer-default">
<p>松浦プレゼミ2024</p>
</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="prezemi_2024_07_presen_files/libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="prezemi_2024_07_presen_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="prezemi_2024_07_presen_files/libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="prezemi_2024_07_presen_files/libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="prezemi_2024_07_presen_files/libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="prezemi_2024_07_presen_files/libs/revealjs/plugin/reveal-chalkboard/plugin.js"></script>
  <script src="prezemi_2024_07_presen_files/libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="prezemi_2024_07_presen_files/libs/revealjs/plugin/notes/notes.js"></script>
  <script src="prezemi_2024_07_presen_files/libs/revealjs/plugin/search/search.js"></script>
  <script src="prezemi_2024_07_presen_files/libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="prezemi_2024_07_presen_files/libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleChalkboard(event)\"><kbd>b</kbd> Toggle Chalkboard</a></li>\n<li class=\"slide-tool-item\" data-item=\"6\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleNotesCanvas(event)\"><kbd>c</kbd> Toggle Notes Canvas</a></li>\n<li class=\"slide-tool-item\" data-item=\"7\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.downloadDrawings(event)\"><kbd>d</kbd> Download Drawings</a></li>\n<li class=\"slide-tool-item\" data-item=\"8\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'chalkboard': {"buttons":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'slide',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1400,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, RevealChalkboard, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    
    <script>
      // htmlwidgets need to know to resize themselves when slides are shown/hidden.
      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
      // slide changes (different for each slide format).
      (function () {
        // dispatch for htmlwidgets
        function fireSlideEnter() {
          const event = window.document.createEvent("Event");
          event.initEvent("slideenter", true, true);
          window.document.dispatchEvent(event);
        }

        function fireSlideChanged(previousSlide, currentSlide) {
          fireSlideEnter();

          // dispatch for shiny
          if (window.jQuery) {
            if (previousSlide) {
              window.jQuery(previousSlide).trigger("hidden");
            }
            if (currentSlide) {
              window.jQuery(currentSlide).trigger("shown");
            }
          }
        }

        // hookup for slidy
        if (window.w3c_slidy) {
          window.w3c_slidy.add_observer(function (slide_num) {
            // slide_num starts at position 1
            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
          });
        }

      })();
    </script>

    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const onCopySuccess = function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "コピーしました");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "コピーしました");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      }
      const getTextToCopy = function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
        text: getTextToCopy
      });
      clipboard.on('success', onCopySuccess);
      if (window.document.getElementById('quarto-embedded-source-code-modal')) {
        const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
          text: getTextToCopy,
          container: window.document.getElementById('quarto-embedded-source-code-modal')
        });
        clipboardModal.on('success', onCopySuccess);
      }
        var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
        var mailtoRegex = new RegExp(/^mailto:/);
          var filterRegex = new RegExp('/' + window.location.host + '/');
        var isInternal = (href) => {
            return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
        }
        // Inspect non-navigation links and adorn them if external
     	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
        for (var i=0; i<links.length; i++) {
          const link = links[i];
          if (!isInternal(link.href)) {
            // undo the damage that might have been done by quarto-nav.js in the case of
            // links that we want to consider external
            if (link.dataset.originalHref !== undefined) {
              link.href = link.dataset.originalHref;
            }
          }
        }
      function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
        const config = {
          allowHTML: true,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start',
        };
        if (contentFn) {
          config.content = contentFn;
        }
        if (onTriggerFn) {
          config.onTrigger = onTriggerFn;
        }
        if (onUntriggerFn) {
          config.onUntrigger = onUntriggerFn;
        }
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note) {
            return note.innerHTML;
          } else {
            return "";
          }
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>